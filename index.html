<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6c5ce7">
    <title>G√©o-Magie Pro - Ousseynou DIOUF</title>
    
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJkZWZhdWx0X2xvY2FsZSI6ICJmciIsCiAgIm5hbWUiOiAiR8Opby1NYWdpZSBQcm8iLAogICJzaG9ydF9uYW1lIjogIkfDZW8tTWFnaWUiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMmQzNDM2IiwKICAidGhlbWVfY29sb3IiOiAiIzZjNWNlNyIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI1ODAvMjU4MDk0NS5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH1hCiAgXQp9">

    <style>
        :root { --primary: #6c5ce7; --secondary: #a29bfe; --dark: #2d3436; --accent: #fdcb6e; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: var(--dark); touch-action: none; }
        .page { position: absolute; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #page-home { background: linear-gradient(135deg, #2d3436 0%, #6c5ce7 100%); overflow-y: auto; color: white; padding: 40px 20px; z-index: 10; }
        #page-app { background: #f0f2f5; transform: translateX(100%); z-index: 5; }
        .show-app #page-home { transform: translateX(-100%); }
        .show-app #page-app { transform: translateX(0); }
        .hero { text-align: center; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; min-height: 100%; }
        h1 { font-size: 3.5rem; margin: 0; background: linear-gradient(to right, #fff, var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5)); }
        .card { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); text-align: left; margin: 10px; }
        .card h3 { margin-top: 0; color: var(--accent); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; }
        .btn-start { background: #00b894; color: white; padding: 22px 50px; border: none; border-radius: 50px; font-size: 1.4rem; font-weight: bold; cursor: pointer; box-shadow: 0 15px 30px rgba(0,0,0,0.3); transition: all 0.3s; margin: 40px auto; width: fit-content; }
        .author-box { background: white; color: var(--dark); padding: 25px; border-radius: 15px; display: inline-block; border-left: 8px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: left; }
        .toolbar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 12px; background: #dfe6e9; }
        #canvas-area { flex-grow: 1; position: relative; background: #ffffff; margin: 6px; border-radius: 12px; }
        canvas { display: block; border-radius: 12px; touch-action: none; width: 100%; height: 100%; }
        #info-box { position: absolute; top: 15px; right: 15px; width: 200px; background: white; border: 3px solid var(--primary); border-radius: 12px; padding: 10px; font-size: 0.8rem; font-weight: bold; z-index: 200; pointer-events: none; }
        .btn-ui { height: 50px; border: 1px solid #b2bec3; border-radius: 12px; background: white; font-weight: bold; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; text-align: center; }
        .btn-ui.active { background: var(--primary) !important; color: white !important; }
        #install-prompt { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); color: var(--dark); padding: 15px 25px; border-radius: 30px; font-weight: bold; display: none; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
    </style>
</head>
<body id="master-body">

    <div id="install-prompt" onclick="installPWA()">Installer G√©o-Magie sur l'√©cran d'accueil üì≤</div>

    <div id="page-home" class="page">
        <div class="hero">
            <h1>G√©o-Magie</h1>
            <p>Outil de G√©om√©trie Dynamique Appliqu√©e</p>
            <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                <div class="card"><h3>üîç Observation</h3><p>Manipulation directe des figures.</p></div>
                <div class="card"><h3>üìè Rigueur</h3><p>Pr√©cision math√©matique garantie.</p></div>
            </div>
            <button class="btn-start" onclick="launchApp()">Commencer l'Exp√©rience üìê</button>
            <div class="author-box" style="margin: 20px auto;">
                <p style="margin: 0; font-size: 0.7rem; color: #b2bec3;">CON√áU PAR :</p>
                <p style="font-size: 1.3rem; font-weight: 900; margin: 0; color: var(--primary);">Ousseynou DIOUF</p>
                <p style="font-size: 0.9rem; margin: 0; color: #636e72;">Formateur en Math√©matiques - CRFPE K√©dougou</p>
            </div>
        </div>
    </div>

    <div id="page-app" class="page">
        <div class="toolbar">
            <button class="btn-ui" style="background:#ffa502; color:white" onclick="undo()">‚Ü©Ô∏è</button>
            <button class="btn-ui" style="background:#2ecc71; color:white" onclick="redo()">‚Ü™Ô∏è</button>
            <button class="btn-ui" onclick="goHome()">üè†</button>
            <button class="btn-ui" style="background:#d63031; color:white" onclick="confirmClear()">üóëÔ∏è</button>
            <button class="btn-ui active" id="btn-point" onclick="setMode('point')">üìç Point</button>
            <button class="btn-ui" id="btn-segment" onclick="setMode('segment')">üìè Segm</button>
            <button class="btn-ui" id="btn-droite" onclick="setMode('droite')">‚ôæÔ∏è Droite</button>
            <button class="btn-ui" id="btn-cercle" onclick="setMode('cercle')">‚≠ï Cercle</button>
        </div>

        <div id="canvas-area">
            <div id="info-box">üìä Guide :<br><span id="msg" style="color:var(--primary);">Pr√™t</span></div>
            <canvas id="geoCanvas"></canvas>
        </div>

        <div class="toolbar">
            <button class="btn-ui" id="btn-mediatrice" onclick="setMode('mediatrice')">üìè M√©dia</button>
            <button class="btn-ui" id="btn-bissectrice" onclick="setMode('bissectrice')">‚úÇÔ∏è Biss</button>
            <button class="btn-ui" id="btn-mediane" onclick="setMode('mediane')">üìâ M√©diane</button>
            <button class="btn-ui" id="btn-hauteur" onclick="setMode('hauteur')">üìê Hauteur</button>
            <button class="btn-ui" id="btn-perp" onclick="setMode('perp')">‚üÇ Perp</button>
            <button class="btn-ui" id="btn-para" onclick="setMode('para')">|| Para</button>
            <button class="btn-ui" id="btn-milieu" onclick="setMode('milieu')">üåì Milieu</button>
            <button class="btn-ui" id="btn-angle" onclick="setMode('angle')">üìê Angle</button>
        </div>

        <div class="toolbar">
            <button class="btn-ui" id="btn-sphere" onclick="setMode('sphere')">üîÆ Sph√®re</button>
            <button class="btn-ui" id="btn-suppr" onclick="setMode('suppr')" style="color:red">üéØ Suppr</button>
            <button class="btn-ui" id="voice-btn" onclick="toggleVoice()">üîä Voix: ON</button>
            <input type="color" id="color" value="#2d3436" style="width:100%; height:50px; border-radius:12px; border:none; background:none;">
        </div>
    </div>

    <script>
        /* --- GESTION PWA : INSTALLATION ET OFFLINE --- */
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-prompt').style.display = 'block';
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-prompt').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'geo-magie-v1';
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                self.addEventListener('fetch', e => {
                    e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
                });
            `;
            const blob = new Blob([swCode], {type: 'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(blob));
        }

        /* --- S√âCURIT√â COMMERCIALE DIOUF-SHIELD --- */
        (function checkActivation() {
            const fingerprint = (screen.width * screen.height) + (navigator.userAgent.length * 99);
            const deviceID = "GEO-" + fingerprint.toString(16).toUpperCase();
            if (!localStorage.getItem('geoMagie_pro_activated')) {
                let key = prompt("üîí ACTIVATION REQUISE\n\nID Appareil : " + deviceID + "\n\nContactez M. Ousseynou DIOUF :");
                if (key === deviceID + "2026") {
                    localStorage.setItem('geoMagie_pro_activated', 'true');
                    alert("‚úÖ Application activ√©e avec succ√®s !");
                } else {
                    document.body.innerHTML = `<div style="background:#2d3436; color:white; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;"><h2>Acc√®s Non Autoris√©</h2><p>ID √† envoyer : <b>${deviceID}</b></p><button onclick="location.reload()" style="padding:10px 20px; background:#6c5ce7; border:none; color:white; border-radius:5px;">Saisir la cl√©</button></div>`;
                    throw new Error("Locked");
                }
            }
        })();

        /* --- LOGIQUE MATH√âMATIQUE (VOS 21 FONCTIONS) --- */
        const canvas = document.getElementById('geoCanvas');
        const ctx = canvas.getContext('2d');
        let mode = 'point', points = [], shapes = [], selected = [], history = [], redoList = [], voice = true;

        function launchApp() { document.body.classList.add('show-app'); setTimeout(resize, 300); parler("Bienvenue dans G√©o Magie"); }
        function goHome() { document.body.classList.remove('show-app'); }
        function resize() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; draw(); }
        window.addEventListener('resize', resize);

        function saveState() {
            if (history.length > 20) history.shift();
            history.push(JSON.stringify({p: points, s: shapes}));
            redoList = []; 
        }

        function undo() {
            if (history.length > 0) {
                redoList.push(JSON.stringify({p: points, s: shapes}));
                let state = JSON.parse(history.pop());
                points = state.p; shapes = state.s;
                draw();
            }
        }

        function redo() {
            if (redoList.length > 0) {
                history.push(JSON.stringify({p: points, s: shapes}));
                let state = JSON.parse(redoList.pop());
                points = state.p; shapes = state.s;
                draw();
            }
        }

        function toggleVoice() { voice = !voice; document.getElementById('voice-btn').innerText = voice ? "üîä Voix: ON" : "üîá Voix: OFF"; }
        function parler(t) { if(!voice) return; window.speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(t); u.lang = 'fr-FR'; window.speechSynthesis.speak(u); }

        const aides = {
            'point': "Placer un point", 'segment': "Relier deux points", 'droite': "Tracer une droite",
            'cercle': "Tracer un cercle", 'mediatrice': "Tracer la m√©diatrice", 'bissectrice': "Tracer la bissectrice",
            'mediane': "Tracer la m√©diane", 'hauteur': "Tracer la hauteur", 'perp': "Tracer la perpendiculaire",
            'para': "Tracer la parall√®le", 'milieu': "Placer le milieu", 'angle': "Mesurer l'angle",
            'sphere': "Cr√©er une sph√®re", 'suppr': "Supprimer un √©l√©ment"
        };

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.btn-ui').forEach(b => b.classList.remove('active'));
            if(document.getElementById('btn-' + m)) document.getElementById('btn-' + m).classList.add('active');
            selected = [];
            document.getElementById('msg').innerText = m.toUpperCase();
            parler(aides[m] || m);
        }

        function handleInput(x, y) {
            let p = points.find(pt => Math.hypot(pt.x - x, pt.y - y) < 25);
            if(mode === 'suppr' && p) {
                saveState();
                points = points.filter(i => i !== p);
                shapes = shapes.filter(s => !s.pts.includes(p));
                parler("Supprim√©");
            } else {
                if(!p) { 
                    saveState();
                    p = { x, y, label: String.fromCharCode(65 + points.length % 26) }; 
                    points.push(p); 
                    if(mode === 'point') parler("Point " + p.label);
                }
                if(mode !== 'point' && mode !== 'suppr') {
                    selected.push(p);
                    let req = (['bissectrice', 'angle', 'mediane', 'hauteur', 'perp', 'para'].includes(mode)) ? 3 : 2;
                    if(selected.length < req) { parler("S√©lectionn√©"); }
                    else if(selected.length === req) {
                        saveState();
                        shapes.push({type: mode, pts: [...selected], col: document.getElementById('color').value});
                        selected = [];
                        parler("Trac√© termin√©");
                    }
                }
            }
            requestAnimationFrame(draw);
        }

        canvas.addEventListener('pointerdown', (e) => {
            const r = canvas.getBoundingClientRect();
            handleInput(e.clientX - r.left, e.clientY - r.top);
        });

        function drawFullLine(p1, p2, col) {
            let dx = p2.x - p1.x, dy = p2.y - p1.y;
            if (dx === 0 && dy === 0) return;
            let len = 5000;
            ctx.beginPath(); ctx.strokeStyle = col; ctx.lineWidth = 2;
            ctx.moveTo(p1.x - dx * len, p1.y - dy * len);
            ctx.lineTo(p1.x + dx * len, p1.y + dy * len);
            ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            shapes.forEach(s => {
                ctx.beginPath(); ctx.strokeStyle = s.col; ctx.lineWidth = 3;
                let [p1, p2, p3] = s.pts;
                let dx = p2 ? p2.x - p1.x : 0, dy = p2 ? p2.y - p1.y : 0;
                
                if(s.type === 'segment') { ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                else if(s.type === 'droite') { drawFullLine(p1, p2, s.col); }
                else if(s.type === 'mediatrice') {
                    let mx = (p1.x+p2.x)/2, my = (p1.y+p2.y)/2;
                    drawFullLine({x:mx, y:my}, {x:mx-dy, y:my+dx}, s.col);
                }
                else if(s.type === 'milieu') { ctx.fillStyle = s.col; ctx.beginPath(); ctx.arc((p1.x+p2.x)/2, (p1.y+p2.y)/2, 6, 0, 7); ctx.fill(); }
                else if(s.type === 'mediane' && p3) { 
                    ctx.moveTo(p3.x, p3.y); ctx.lineTo((p1.x+p2.x)/2, (p1.y+p2.y)/2); ctx.stroke(); 
                }
                else if(s.type === 'hauteur' && p3) {
                    let d2 = dx*dx + dy*dy;
                    if (d2 > 0) {
                        let t = ((p3.x - p1.x) * dx + (p3.y - p1.y) * dy) / d2;
                        ctx.moveTo(p3.x, p3.y); ctx.lineTo(p1.x + t * dx, p1.y + t * dy); ctx.stroke();
                    }
                }
                else if(s.type === 'perp' && p3) { drawFullLine(p3, {x: p3.x - dy, y: p3.y + dx}, s.col); }
                else if(s.type === 'para' && p3) { drawFullLine(p3, {x: p3.x + dx, y: p3.y + dy}, s.col); }
                else if(s.type === 'bissectrice' || s.type === 'angle') {
                    let a1 = Math.atan2(p1.y-p2.y, p1.x-p2.x), a2 = Math.atan2(p3.y-p2.y, p3.x-p2.x);
                    let diff = a2 - a1;
                    while (diff < -Math.PI) diff += Math.PI * 2;
                    while (diff > Math.PI) diff -= Math.PI * 2;
                    if (s.type === 'angle') {
                        ctx.fillStyle = s.col + "33"; ctx.beginPath(); ctx.moveTo(p2.x, p2.y);
                        ctx.arc(p2.x, p2.y, 40, a1, a1 + diff, diff < 0); ctx.closePath(); ctx.fill(); ctx.stroke();
                        let deg = Math.abs(diff * 180 / Math.PI);
                        if(deg > 180) deg = 360 - deg;
                        let tx = p2.x + Math.cos(a1 + diff / 2) * 65, ty = p2.y + Math.sin(a1 + diff / 2) * 65;
                        ctx.fillStyle = "black"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
                        ctx.fillText(deg.toFixed(1) + "¬∞", tx, ty);
                    } else {
                        let af = a1 + diff / 2;
                        ctx.moveTo(p2.x, p2.y); ctx.lineTo(p2.x + Math.cos(af) * 1000, p2.y + Math.sin(af) * 1000); ctx.stroke();
                    }
                }
                else if(s.type === 'sphere') {
                    let r = Math.hypot(p2.x-p1.x, p2.y-p1.y);
                    let g = ctx.createRadialGradient(p1.x-r/3, p1.y-r/3, r/10, p1.x, p1.y, r);
                    g.addColorStop(0, '#fff'); g.addColorStop(0.5, s.col); g.addColorStop(1, '#000');
                    ctx.fillStyle = g; ctx.beginPath(); ctx.arc(p1.x, p1.y, r, 0, 7); ctx.fill();
                }
                else if(s.type === 'cercle') { ctx.beginPath(); ctx.arc(p1.x, p1.y, Math.hypot(p2.x-p1.x, p2.y-p1.y), 0, 7); ctx.stroke(); }
            });
            points.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, 7);
                ctx.fillStyle = selected.includes(p) ? "#fdcb6e" : "#2d3436";
                ctx.fill(); ctx.fillStyle = "#2d3436"; ctx.font = "bold 16px Arial"; ctx.textAlign = "left";
                ctx.fillText(p.label, p.x+12, p.y-12);
            });
        }
        function confirmClear() { if(confirm("Effacer tout le plan ?")) { saveState(); points=[]; shapes=[]; draw(); parler("Plan effac√©"); } }
    </script>
</body>
</html>
